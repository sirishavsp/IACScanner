/* security_and_vulnerability_analysis.tf */

/* 3.4.5 Regular Expression Matching
This policy allows all actions which is highly insecure and violates the principle of least privilege.
*/
resource "aws_iam_policy" "admin" {
  name   = "admin"
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "*"
        Effect = "Allow"
        Resource = "*"
      },
    ]
  })
}

/* 3.4.6 Unintended destruction
Prevent accidental deletion of important resources by using prevent_destroy lifecycle directive.
*/
resource "aws_s3_bucket" "important_bucket" {
  bucket = "important_bucket"
  acl    = "private"

  lifecycle {
    prevent_destroy = false
  }
}

/* 3.4.8 Code Complexity
Complexity increases when different resources are tangled together in a complex dependency chain.
*/
resource "aws_instance" "web" {
  ami           = "${data.aws_ami.ubuntu.id}"
  instance_type = "t2.micro"
  depends_on    = [aws_iam_role_policy.example, aws_s3_bucket.bucket, aws_security_group.allow_http]
}
